#! /usr/bin/env nix-shell
#! nix-shell -i bash -p busybox

# Create a pipe for processing commands
mkfifo shell-pipe

# Set up a bash shell to process the commands sent to the pipe
(tail -f shell-pipe | sh 2>&1 ) &

while IFS='' read p; do

  echo "$p"

  command=$(echo $p | sed -n 's/^$ //p')

  if [ -n "$command" ] ; then
    echo $command > shell-pipe
    sleep 1
  fi
done

# Close the pipe and delete it
fuser -TERM -k shell-pipe > /dev/null
rm shell-pipe
